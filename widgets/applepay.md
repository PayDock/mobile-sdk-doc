# Apple Pay Widget

Use the iOS SDK to make payments using Apple Pay. The logic of this widget exists as a single view that you can initialise and embed in your payment flow.

## How to use the Apple Pay widget

The **ApplePayView** can be initialised as follows:

```Swift
ApplePayWidget(
    applePayRequestHandler: @escaping (_ applePayRequest: @escaping (ApplePayRequest) -> Void) -> Void,
    completion: @escaping (Result<ChargeResponse, ApplePayError>) -> Void)
```

If the charge is successful, the **ApplePayView** returns a ChargeResponse that contains all the relevant information. In case of an error, the **ApplePayError** object is returned with information regarding the failure.

The **ApplePayRequest** contains all of the required data to enable Apple Pay.

```Swift
public struct ApplePayRequest {
    public let token: String
    public let request: PKPaymentRequest

    public init(token: String, request: PKPaymentRequest) {
        self.token = token
        self.request = request
    }
}
```

The Mobile SDK provides convenient helper methods to initialise the **PKPaymentRequest** object. You can configure this in various ways, depending on your use case:

```Swift
    public static func createApplePayRequest(
        amount: Decimal,
        amountLabel: String,
        countryCode: String,
        currencyCode: String,
        merchantIdentifier: String,
        merchantCapabilities: PKMerchantCapability = [.credit, .debit, .threeDSecure],
        supportedNetworks: [PKPaymentNetwork] = [.visa, .masterCard, .amex, .discover],
        requireBillingAddress: Bool = true,
        requireShippingAddress: Bool = false,
        shippingOptions: [PKShippingMethod]? = nil) -> PKPaymentRequest {
            let item = PKPaymentSummaryItem(label: amountLabel, amount: amount as NSDecimalNumber, type: .final)
            let paymentRequest = PKPaymentRequest()
            paymentRequest.paymentSummaryItems = [item]
            paymentRequest.countryCode = countryCode
            paymentRequest.currencyCode = currencyCode
            paymentRequest.merchantIdentifier = merchantIdentifier
            paymentRequest.merchantCapabilities = merchantCapabilities
            paymentRequest.supportedNetworks = supportedNetworks
            paymentRequest.requiredBillingContactFields = requireBillingAddress ? [.name, .postalAddress] : []
            paymentRequest.requiredShippingContactFields = requireShippingAddress ? [.phoneNumber, .emailAddress, .postalAddress, .name] : []
            paymentRequest.shippingMethods = shippingOptions
            return paymentRequest
    }
```

The following is an example of an **ApplePayView** initialisation:

```Swift
struct ApplePayExampleView: View {
    var body: some View {
        ApplePayWidget { onApplePayButtonTap in
            onApplePayButtonTap(<Your ApplePayRequest>)
        } completion: { result in 
            switch result {
                case .success(let chargeResponse): // Handle successfull result
                case .failure(let error): // Handle error
            }
        }
    }
}

func getApplePayRequest() -> ApplePayRequest {
    let paymentRequest = MobileSDK.createApplePayRequest(
        amount: 0.01,
        amountLabel: "Amount",
        countryCode: "AU",
        currencyCode: "AUD")

    let applePayRequest = ApplePayRequest(
        token: <Merchant wallet token>,
        request: paymentRequest)

    return applePayRequest
}
```

## Definitions

### MobileSDK.ApplePayRequest
| Name               | Definition                                                                                                               | Type                     | Mandatory/Optional |
| :----------------- | :----------------------------------------------------------------------------------------------------------------------- | :----------------------- | :----------------  |
| token              |  Wallet charge token that is generated by merchant backend                                                               | Swift.String             | Mandatory          |
| request            |  Data for configuration of Apple Pay. Can be built manually or using the helper method MobileSDK.createApplePayRequest() | PassKit.PKPaymentRequest | Mandatory          |

### MobileSDK.ChargeResponse
| Name     | Definition                                       | Type          | Mandatory/Optional |
| :------- | :----------------------------------------------- | :------------ | :----------------  |
| status   |  Status of an ApplePay payment after completion. | Swift.String  | Mandatory          |
| amount   |  The amount of money that was charged            | Swift.Decimal | Mandatory          |
| currency |  Currency of the charge.                         | Swift.String  | Mandatory          |

### MobileSDK.ApplePayError

| Name          | Error message                                    | Type  |
| :------------ | :----------------------------------------------- | :---- |
| initFailed    |  Initialisation of Apple Pay has failed          | Error | 
| paymentFailed |  Processing the payment has failed.              | Error |
